+++
title = "局域网信息收集"
+++

## 枚举主机并识别域控制器

<https://notes.benheater.com/books/active-directory/page/enumerating-hosts-and-identifying-the-domain-controllers>

- 内部网络

```bash
sudo nmap -Pn -p- -T4 -A -oN nmap-scan.txt -iL targets.txt
```

- 外部网络（考虑上传nmap）

```bash
+++
title = " -sT             : Use TCP full connect flag due to scanning through a proxy"
+++
+++
title = "--top-ports 1000 : Top 1,000 ports due to slow speeds with TCP full connect scanning "
+++
sudo proxychains -q nmap -Pn -sT --top-ports 1000 -T4 -A -oN nmap-scan.txt -iL targets.txt
```

当您查看域控制器时，它的运行服务非常明显；类似于这样：

```bash
PORT     STATE SERVICE
53/tcp   open  domain
88/tcp   open  kerberos-sec
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
389/tcp  open  ldap
445/tcp  open  microsoft-ds
464/tcp  open  kpasswd5
593/tcp  open  http-rpc-epmap
636/tcp  open  ldapssl
3268/tcp open  globalcatLDAP
3269/tcp open  globalcatLDAPssl
```

## ldap-rootdse | LDAP 根 DSE 信息

每个目录服务器都有一个名为 RootDSE 的唯一条目。 它提供服务器的相关数据，例如其功能、支持的 LDAP 版本以及使用的命名上下文。

根DSE是LDAP服务器目录信息树顶部的条目。 LDAP服务器中的所有命名上下文（namingcontexts (suffixes，后缀)）直接位于根DSE下方。 根DSE包含有关LDAP服务器的信息，包括已配置的命名上下文和服务器的功能。

- 内部网络

```bash
+++
title = "Assumes 10.10.10.2 is the DC based on port enumeration"
+++
sudo nmap -Pn -T4 -p 389,636 --script ldap-rootdse 10.10.10.2 | grep dnsHostName | sort -u
```

- 外部网络

```bash
+++
title = "Via Proxy Host"
+++
+++
title = "Assumes 10.10.10.2 is the DC based on port enumeration"
+++
sudo proxychains -q nmap -Pn -T4 -sT -p 389,636 --script ldap-rootdse 10.10.10.2 | grep dnsHostName | sort -u
```

## RID Cycling to Enumerate Users | RID 循环枚举用户

前提：允许空会话

根据此文章反向操作开启空会话：
[How to Disable Null Session in Windows](https://www.blumira.com/integration/how-to-disable-null-session-in-windows/)

```bash
enum4linux -a -r -K 5000 10.80.80.2
```

## Anonymous LDAP Queries | 匿名 LDAP 查询

```bash
ldapsearch -x -H ldap://10.80.80.2 -D 'CN=anonymous,DC=ad,DC=lab' -W -b 'DC=ad,DC=lab' 'objectClass=user'
```

以“<anonymous@ad.lab>”身份进行身份验证，当提示输入密码时，按 Enter

## kerbrute | Kerberos 爆破

### 枚举用户名

```bash
kerbrute userenum --dc ad.lab -d ad.lab /usr/share/wordlists/rockyou.txt
```

## samba服务

[smb.md](../../漏洞发现/2.服务安全/smb.md)
