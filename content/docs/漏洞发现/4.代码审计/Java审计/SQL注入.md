# Java审计-SQL注入

## 三种数据库模式

- `JDBC`：Java Database Connectivity，Java数据库连接，是一种用于执行SQL语句的Java API，可以为多种关系数据库提供统一访问，它由一组用Java语言编写的类和接口组成。

- `Mybatis`（最常用）：MyBatis是一个优秀的持久层框架，它对jdbc的操作数据库的过程进行封装，使开发者只需要关注 SQL 本身，而不需要花费精力去处理例如注册驱动、创建connection、创建statement、手动设置参数、结果集检索等jdbc繁杂的过程代码。

- `Hibernate`：Hibernate是一个开放源代码的对象关系映射框架，它对JDBC进行了非常轻量级的对象封装，它将POJO与数据库表建立映射关系，是一个全自动的orm框架，hibernate可以自动生成SQL语句，自动执行，使得Java程序员可以使用面向对象的思维来操纵数据库。

## 判断是否出现注入

原生JDBC是否存在直接拼接SQL语句（使用+，或者使用StringBUilder append()），未经过预编译；
Mybatis使用${}；
Hibernate、JPA默认是经过预编译的，但是如果开发自己编写的SQL语句，也需要进行检查；
Java是强类型语言，当注入参数为long、int等数字类型时无法进行注入；
找到危险函数位置之后，向上搜索，找函数、方法调用位置，直到请求入口（controller层），判断是否存在无害化处理、无害化处理是否严格；
参考：<https://mp.weixin.qq.com/s/9t3t6qxosGsKiXMIRtMoPw>

## 判断使用的数据库模式

- 看项目说明使用的技术框架
- 看引用中加载那些技术框架
- 看配置源码中相关配置文件

## 入口确定

1. 是否使用预编译技术，预编译是否完整。
2. 定位SQL语句上下文，查看是否有参数直接拼接，是否有对模糊查询关键字的过滤。
3. Mybatis框架则搜索${}，四种情况无法预编译：like模糊查询、order by排序、范围查询in、动态表名/列名，只能拼接，所以还是需要手工防注入，此时可查看相关逻辑是否正确。
4. JPA搜索JpaSort.unsafe()，查看是否用实体之外的字段对查询结果排序，进行了SQL的拼接。以及查看EntityManager的使用，也可能存在拼接SQL的情况。

- `Statement`
- `createStatement`
- `PrepareStatement`
- `like '%${`
- `in(${`
- `in (${`
- `select`
- `update`
- `insert`
- `delete`
- `${`
- `order by`
- `setObject(`
- `setInt(`
- `setString(`
- `setSQLXML(`
- `createQuery(`
- `createSQLQuery(`
- `createNativeQuery`
- .......

## 案例1-非框架JDBC-Jfinal_cms论坛系统

- <https://github.com/jflyfox/jfinal_cms>
- 分析：确定非框架->搜关键字`order by append->getBaseForm()->getOrderBy()->getOrderColumn->orderColumn`
- 路由：`Post: /admin/advicefeedback/list`
- 参数：`form.orderColumn`
- 拼接：`order by ").append(orderBy);`
- Poc：`' xxx #` (直接sqlmap梭哈)

## 案例2-SpringBoot+Mybatis-Oasys办公系统

- <https://gitee.com/aaluoxiang/oa_system>
- 分析：确定Mybatis框架->搜关键字`${->%${baseKey}%->sortMyNotice->sortMyNotice->informListPaging->`
- 路由：`Post: /informlistpaging`
- 参数：`baseKey`
- 拼接：`and n.title LIKE '%${baseKey}%'`
- Poc：`' xxx #` (直接sqlmap梭哈)

## 案例3-SpringBoot+Mybatis-Ruoyi若依系统 V4.6

- <https://gitee.com/y_project/RuoYi>
- 基于springboot中，执行SQL三个调用：
  1. 业务层调用dao层
  2. controller调用Service层间接调用dao层
  3. controller直接调用dao层
- 分析：确定Mybatis框架->搜关键字`${->updateDeptStatus->updateParentDeptStatus->updateDept->editSave`
- 路由：`Post: /system/dept/edit`
- 参数：`ancestors`
- 拼接：`where dept_id in (${ancestors})`
- Poc：`DeptName=1&DeptId=100&ParentId=12&Status=0&OrderNum=1&ancestors=0)or(extractvalue(1,concat((select user()))));#`
