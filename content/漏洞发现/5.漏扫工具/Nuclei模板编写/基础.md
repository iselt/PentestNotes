# Nuclei 模板编写基础

## YAML 基本语法

YAML（YAML Ain't Markup Language）是一种以可读性为主要目标的数据序列化语言，常用于配置文件。以下是YAML的基本语法：

### 1. 基本结构

- **键值对**：用冒号分隔键和值，键和值之间有一个空格。

  ```yaml
  key: value
  ```

- **嵌套结构**：使用缩进表示层级关系，缩进可以是空格但不能是制表符，通常使用**两个空格**。

  ```yaml
  parent:
    child: value
  ```

### 2. 列表

- **行内列表**：用方括号表示，元素之间用逗号分隔。

  ```yaml
  list: [item1, item2, item3]
  ```

- **块状列表**：每个元素前用一个短横线和一个空格。

  ```yaml
  list:
    - item1
    - item2
    - item3
  ```

### 3. 字典

- **行内字典**：用花括号表示，键值对之间用逗号分隔。

  ```yaml
  dictionary: {key1: value1, key2: value2}
  ```

- **块状字典**：每个键值对占一行，冒号和值之间有一个空格。

  ```yaml
  dictionary:
    key1: value1
    key2: value2
  ```

### 4. 多行字符串

- **块状字面值（保留换行）**：用 `|` 表示。

  ```yaml
  multiline: |
    Line 1
    Line 2
    Line 3
  ```

- **块状折叠（折叠换行）**：用 `>` 表示，空行会被折叠成一个空格。

  ```yaml
  folded: >
    This is a
    folded string
    example.
  ```

### 5. 注释

- **注释**：用 `#` 表示。

  ```yaml
  key: value  # This is a comment
  ```

### 6. 引用

- **锚点（Anchor）**：用 `&` 定义一个锚点。

  ```yaml
  defaults: &defaults
    adapter: postgres
    host: localhost
  ```

- **别名（Alias）**：用 `*` 引用一个锚点。

  ```yaml
  development:
    database: dev_db
    <<: *defaults
  ```

### 7. 复杂数据类型

- **日期**：

  ```yaml
  date: 2023-05-31
  ```

- **布尔值**：

  ```yaml
  boolean_true: true
  boolean_false: false
  ```

- **Null值**：

  ```yaml
  null_value: null
  ```

### 注意点

1. **大小写敏感**：YAML对大小写敏感，这意味着键名的大小写必须精确匹配。
2. **使用缩进表示层级关系**：YAML通过缩进来表示数据的层级结构。缩进时不允许使用Tab键，只允许使用空格键。缩进的空格数目不重要，只要相同层级的元素左侧对齐即可。
3. **注释**：使用#符号表示注释，从#字符开始到行尾的内容都会被解析器忽略。
4. **数据类型**：YAML支持的数据类型包括对象（键值对的集合）、数组（一组按次序排列的值）、纯量（单个的、不可再分的值，如字符串、布尔值、整数、浮点数等）。
5. **变量使用**：YAML提供了锚点（&）和引用（*）的语法，用于复用数据，避免重复定义。
6. **复合结构**：对象和数组可以结合使用，形成复合结构，如在一个YAML文件中定义多个对象或数组。

## Nuclei 模板语法

### 1. id

id不能有中文、特殊字符、--以及空格等内容

id这个参数，您可以理解为是输出的标题，一个简单易懂的ID，可以让您更快的判断出，该漏洞的大致情况：

正确写法：`seeyon-xxxx-rce`

错误写法：`seeyon--xxxx-rce`或 `用友 xxxx-rce`

在语法错误后，nuclei执行时会提示 `Could not run nuclei: no templates provided for scan`，当看到该提示时，记得先排查下模板id是否存在特殊字符；

### 2. info

信息块，名称 、 作者 、 严重性 、 描述 、参考和 标签 ，这些都属于信息块的范围，一般情况下，我们只需要写入名称、作者、严重性、描述、标签这几项即可；

- name：模板名称，这个建议跟 id 相同即可；

- author：作者名称，标识版权的一种方式，但是加不加也就那样，毕竟下载后随时可以更改，也保护不了啥。

- severity：严重性，这里不可以使用中文，一般用 `critical`、`hight`、`medium`、`info` 来表示威胁等级；

- description：漏洞介绍，这里可以使用中文，也不限制特殊字符，一般是用来做漏洞介绍用的，可以方便使用者了解该漏洞的具体说明；

- tags：标签，是为了给漏洞加一个标签，方便进行统一扫描，例如：tags: seeyon(切记不要用中文哈)

### 示例

```yaml
id: jindie-EAS-myUploadFile-upload

info:
   name: jindie-EAS-myUploadFile-upload
   author: 思沃科技
   severity: critical
   description: 金蝶EAS myUploadFile任意文件上传
   tags: Kingdee
```

## POC

协议:

- HTTP
- Headless
- Network
- DNS
- File
- JavaScript
- Code
- Flow
- Multi-protocol

<https://docs.projectdiscovery.io/templates/protocols>

### HTTP 示例

```yaml
http:
  - method: GET
    path:
      - "{{BaseURL}}/login.php"
    redirects: true
    max-redirects: 3
```

```yaml
http:
  - raw:
    - |
        POST /path2/ HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded

        a=test&b=pd
```

## 常用匹配/筛选器

### matchers

所支持参数：

1. size：判断返回包大小
1. word ：关键词匹配
1. regex ：正则表达式
1. binary ：要为十六进制响应匹配二进制
1. dsl：匹配协议响应

#### 示例

```yaml
#检查响应的大小是否大于1000字节
matchers:
  - size: ">1000"

#匹配包含 “error” 关键词的响应
matchers:
  - word: "error"
 
#匹配响应中的版本号：
matchers:
  - regex: "Version: (\\d+\\.\\d+\\.\\d+)"
  
#如果期望响应的前两个字节是 0x01 0x02：
matchers:
  - binary: "0102"

#匹配 HTTP 响应码为 200 的情况：
matchers:
  - dsl: "response_code == 200"
```

### extractors

#### regex

正则表达式提取器，通过该方法，将正则表达式匹配到的内容，提取到指定变量中去使用。在下面的示例中，如果响应中包含类似 “Version: 1.2.3” 的文本，它将提取版本号并存储在名为 version 的变量中。

```yaml
extractors:
  - regex:
      pattern: "Version: (\\d+\\.\\d+\\.\\d+)"
      target: version
```

#### json

用于从 JSON 块中提取对象的值，同时该提取器也支持赋值。在下面的示例中，如果 JSON 响应包含一个名为 user 的对象，其中有一个名为 name 的属性，它将提取该属性的值并存储在名为 username 的变量中。

```yaml
extractors:
  - json:
      path: .user.name
      target: username
```

#### xpath

从 HTML 响应中提取属性值的xpath提取器，在下面的示例中，如果 HTML 响应包含一个 `<img>` 标签，它将提取 src 属性的值并存储在名为 image_url 的变量中

```yaml
extractors:
  - xpath:
      expression: //img/@src
      target: image_url
```

## yaml内置保留字

- `{{BaseURL}}`：表示完整的基本 URL，例如 `https://example.com:443/foo/bar.php`。
- `{{Hostname}}`：这是一个常用的保留字，表示主机名。
- `{{randstr}}`：这是一个随机字符串。
- `{{rand_int(1,9999)}}`：这是一个生成 1 到 9999 之间随机整数的保留字。
- `{{RootURL}}`：表示不包含路径和文件的基本 URL，例如 `https://example.com:443`。
- `{{Host}}`：表示主机名，例如 `example.com`。
- `{{Port}}`：表示端口号，例如 `443`。
- `{{Path}}`：表示路径，例如 `/seeyon/login`。
- `{{File}}`：表示文件名，例如 `bar.php`。
- `{{Scheme}}`：表示协议，例如 `https`。
- `{{hex_decode("")}}`：这是一个十六进制解码的保留字。
- `{{md5()}}`：这是一个 MD5 转换的保留字。

## 变量

### 定义变量

在 YAML 中，可以使用 variables 来定义变量，例如下面的代码将"ABCDEFG"的内容保存在名为token的变量中即 token = "ABCDEFG"

```yaml
variables:
  token: "ABCDEFG"
```

使用方法：将变量放到`{{变量名}}`中去，举个例子，下面请求中的 Authorization 头部会使用 token 变量的值

```yaml
requests:
  - method: GET
    path: /api/some-endpoint
    headers:
      Authorization: "Bearer {{token}}"
```

### 攻击载荷

在 YAML 中，payloads 用来提供攻击载荷的部分

```yaml
payloads:
  变量名: 变量内容
```

在攻击载荷这里可以选择攻击模式 (Attack)，支持的参数有三种：

1. 攻城锤(batteringram)，只使用一个有效载荷集，例如：

    ```yaml
    payloads:
      username: ["admin", "user", "test"]
      password: ["password123", "123456", "letmein"]
    ```

2. 集束炸弹(clusterbomb)，将尝试所有用户名和令牌的组合

    ```yaml
    payloads:
      username: ["admin", "user", "test"]
      token: ["abc123", "xyz456", "pqr789"]
    ```

3. 干草叉(Pitchfork)，干草叉攻击型为每个位置使用一个有效载荷集。它将第一个有效载荷置于第一个位置，将第二个有效载荷置于第二位置，依此类推

    ```yaml
    payloads:
      query: ["admin", "user", "test"]
      page: [1, 2, 3]
    ```

示例：

```yaml
payloads:
  yypath:
    - '/service/~baseapp/UploadServlet'
    - '/service/ECFileManageServlet'
    - '/servlet/~ic/nc.bs.framework.mx.monitor.MonitorServlet'
    - '/servlet/~ic/nc.bs.framework.mx.MxServlet'
    - '/servlet/~uapxbrl/uap.xbrl.persistenceImpl.XbrlPersistenceServlet'
    - '/servlet/~uapss/com.yonyou.ante.servlet.FileReceiveServlet'
    - '/servlet/~ic/nc.document.pub.fileSystem.servlet.DownloadServlet'
    - '/servlet/~ic/nc.document.pub.fileSystem.servlet.UploadServlet'
    - '/servlet/~ic/nc.document.pub.fileSystem.servlet.DeleteServlet'
    - '/servlet/~ic/com.ufida.zior.console.ActionHandlerServlet'
    - '/ServiceDispatcherServlet'
    - '/servlet/~baseapp/nc.message.bs.NCMessageServlet'
    - '/fs/update/DownloadServlet'
    - '/service/~cc/nc.bs.logging.config.LoggingConfigServlet'    

requests:
  - method: GET
    path: "{{ yypath }}"
```

## 参考

> [Nuclei Template Structure](https://docs.projectdiscovery.io/templates/structure)
>
> [【脚本编写】Nuclei-yaml脚本速成新手教程--基础篇](https://mp.weixin.qq.com/s/9n13N28-c_zmaqae2-iAUw)
