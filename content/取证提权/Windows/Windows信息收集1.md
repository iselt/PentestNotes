# Windows 信息收集

<https://blog.csdn.net/qq_63844103/article/details/128132052>

## 系统信息

### 1. 系统程序

| 命令                                                                 | 描述                       |
|----------------------------------------------------------------------|----------------------------|
| `net config workstation`                                             | 查询简易系统信息           |
| `systeminfo`                                                         | 查询全部内容               |
| `wmic qfe get Caption,Description,HotFixID,InstalledOn`              | 查询已安装的补丁列表       |

> 📝 其中systeminfo命令查询内容最全，但如果系统更新的补丁较多，可能会导致反应反应时间过长；使用 webshell 执行此命令可能会因为超时导致无法正常回显，或回显内容长度过长，无法全部显示。

### 2. 进程服务

| 命令                                                                 | 描述                                           |
|----------------------------------------------------------------------|------------------------------------------------|
| `tasklist /v`                                                        | 查询正在运行的进程                             |
| `wmic product get name,version`                                      | 查询所有安装过的软件及版本                     |
| `powershell "Get-WmiObject -class Win32_Product \| Select-Object -Property name,version"` | 使用 PowerShell 查询所有安装过的软件及版本，效果和 wmic 相同 |
| `wmic service list brief`                                            | 查询当前机器的服务信息                         |
| `wmic startup get command,caption`                                   | 查看启动项                                     |
| `schtasks /query /fo LIST /v`                                        | 查看任务计划                                   |

Windows 自带防火墙及特殊过滤规则等网络访问均可使用netsh及相关命令查看。

| 命令                                                                 | 描述                               |
|----------------------------------------------------------------------|------------------------------------|
| `netsh firewall show config`                                         | 查看防火墙信息，但 `firewall` 命令已弃用，可使用 `advfirewall` 命令代替 |
| `netsh advfirewall firewall show rule name=all`                      | 查看配置规则                       |
| `netsh advfirewall set allprofiles state off\on`                     | 关闭防火墙\开启防火墙              |
| `netsh advfirewall export\import xx.pol`                             | 导出\导入配置文件                  |
| `netsh advfirewall firewall add rule name=”deny tcp 139″ dir=in protocol=tcp localport=139 action=block` | 新建规则阻止TCP协议139端口         |
| `netsh advfirewall firewall add rule name="Remote Desktop" protocol=TCP dir=in localport=3389 action=allow` | 新建规则允许3389通过防火墙         |
| `netsh advfirewall firewall delete rule name=Remote Desktop`         | 删除名为Remote Desktop的规则       |
| `netsh interface`                                                    | 连接安全规则配置，很少配置         |

### 3. 用户信息

| 命令                          | 描述                           |
|-------------------------------|--------------------------------|
| `whoami`                      | 当前用户                       |
| `quser`                       | 查询登录用户，同 `query user`  |
| `qwinsta`                     | 查询登录用户，同 `query user`  |
| `query user`                  | 查询登录用户                   |
| `query session`               | 查询会话                       |
| `query termserver`            | 查询远程桌面主机列表           |
| `net accounts`                | 查询域密码策略                 |
| `net user`                    | 查询本地用户列表               |
| `net user "$username"`        | 查询指定用户                   |
| `net localgroup`              | 查询本地用户组列表             |
| `net localgroup "$groupname"` | 查询指定用户组成员             |
| `net group`                   | 仅域控可执行，查询用户组列表   |
| `net group "$groupname"`      | 仅域控可执行，查询用户组成员   |

> 📝 quser、qwinsta和query命令只存在于允许安装 RDP 服务的主机上，官方描述其仅存在于 server 2012 及以上版本存在。其中query termserver命令存在问题，本地测试时与描述严重不符，无法列出信息。

### 4. 操作记录

> cmd 和 powershell v3 以下的操作记录无法长时间保存，仅限当前窗口。

| 命令                                      | 描述                                     |
|-------------------------------------------|------------------------------------------|
| `Get-History \| Format-List -Property *`  | 查询 PowerShell 当前窗口历史操作记录     |
| `Clear-History`                           | 删除 PowerShell 当前窗口历史操作记录     |
| `Clear-History -Id 3`                     | 删除 PowerShell 当前窗口指定 ID 的历史操作记录 |
| `doskey /h`                               | 查看 CMD 的历史操作记录                  |
| `doskey /reinstall`                       | 删除 CMD 的历史操作记录                  |

可以通过向进程发送键盘内容的方式将运行中的窗口历史操作记录导出。

> powershell v5 以上的操作历史记录会直接保存在指定文件中。直接查看即可。

```cmd
# 查看 powershell 历史操作记录，powershell v3、v4 版本需要安装Get-PSReadlineOption。
type %appdata%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
```

## 拓扑信息

## 凭证信息
